#!/bin/bash

# This script is only for Linux builds.  Windows builds follow basically the same steps,
# but obviously the actual build part needs to be done on a Windows machine first.

# Copy libraries from the system folder to our local lib folder
# This way our lib folder always matches what gets compiled
LIBS="libGLEW libSDL- libSDL_image libSDL_net libSDL_ttf libalut libboost_filesystem libboost_system libfreetype libgcc_s libogg libopenal libstdc++ libvorbis libvorbisfile libxerces-c libz libcurl libnsl"
RELEASE=543
outfile=buildoutput

if [ $# != 1 ]
then
   echo "Warning: Will upload full build.  This can take a while."
fi

rm $outfile

if [ ! -z `uname -m | grep x86_64` ]
then
   LIB=lib64
else
   LIB=lib
fi

echo "Building"
git pull >> $outfile 2>&1
REVISION=`git log --pretty=oneline | wc -l`
cd build
make clean >> $outfile 2>&1
make -j3 >> $outfile 2>&1
cd ..
cp build/coldest . >> $outfile 2>&1
cp build/server . >> $outfile 2>&1

# This needs to happen after the build or the binary isn't going to be there/up to date.
echo "Copying libraries"
mkdir lib >> $outfile 2>&1
rm lib/* >> $outfile 2>&1
for i in $LIBS
do
   REALFILE=`ldd ./coldest | grep $i | sed -e 's/[ \t]*\(.*\) *=> *\(.*\) .*/\2/'`
   cp $REALFILE ./lib || echo "Failed to copy $REALFILE" >> $outfile 2>&1
   echo $REALFILE >> $outfile 2>&1
done

# This one is not in the ldd output because it is dynamically opened by libSDL_image, so we have to
# hardcode it.  I don't anticipate it changing much though so that should be okay.
cp /usr/$LIB/libpng.so.3 ./lib >> $outfile 2>&1
echo "/usr/$LIB/libpng.so.3" >> $outfile 2>&1

rm -rf Coldest$REVISION >> $outfile 2>&1
echo $REVISION > version
echo "Kitting"
./kit.sh Coldest$REVISION >> $outfile 2>&1
echo "Packaging"
./package.sh linux Coldest$REVISION >> $outfile 2>&1
# Patches should no longer be necessary thanks to the updater
#echo "Building Patch"
#./buildpatch linux $RELEASE >> $outfile 2>&1
echo "Uploading"
#./uploadbuild.sh linux $1 >> $outfile 2>&1

